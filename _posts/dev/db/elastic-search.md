# elastic search 소개

루씬(자바 라이브러리) 기반의 오픈소스 검색 엔진

json 기반의 문서를 저장하고 검색할 수 있으며 분석 작업도 가능

특징은 아래와 같다.

- 준실시간 검색 시스템
    - 실시간이라고 생각될 만큼 색인된 데이터가 빠르게 검색된다.

- 고가용성을 위한 클러스터 구성
    - 한 대 이상의 노드로 클러스터를 구성하여 높은 수준의 안정성을 달성하고 부하 분산이 가능하다.

- 동적 스키마 생성
    - 입력될 데이터들에 대해 미리 스키마를 정의하지않아도 동적으로 스키마를 생성할 수 있다.

- rest api 기반의 인터페이스
    - rest api 기반의 인터페이스를 제공하여 비교적 사용을 위한 진입 장벽이 낮다.

# 클러스터와 노드 이해하기

컴퓨터 클러스터는 여러 대의 컴퓨터들이 연결되어 하나의 시스템처럼 동작하는 컴퓨터들의 집합을 의미한다.

노드의 종류는 아래와 같다.

| 종류       | 역할                    |
|----------|-----------------------|
| 마스터 노드   | 클러스터 상태 관리 및 메타데이터 관리 |
| 데이터 노드   | 문서 색인 및 검색 요청 처리      |
| 코디네이팅 노드 | 검색 요청 처리              |
| 인제스트 노드  | 색인되는 문서의 데이터 전처리      |

클러스터이므로 어떤 노드에 어떤 요청을 해도 동일한 응답을 준다.

마스터 노드가 데이터를 요청받으면, 직접 데이터노드에게 쿼리해서 전달한다.

# 인덱스란?

문서들이 저장되는 논리적인 공간이다. 

| ES       | RDB      |
|----------|----------|
| index    | database |
| mapping  | schema   |
| document | row      |

인덱스를 설계하는것이 es를 사용하기 위해 처음 고려되어야한다.

예를 들어서 도서관 시스템을 만든다고 가정해보자.

도서관이라는 인덱스에 모든 데이터를 밀어 넣는 방법이 있고, 소설, 매거진 등등의 인덱스를 만들어서 나눠 담는 방법도 있다.

| 케이스            | 장점                                | 단점                                 |
|----------------|-----------------------------------|------------------------------------|
| 하나의 인덱스를 사용할 때 | 관리해야할 인덱스의 수가 적어 관리 리소스가 적게 발생한다. | 쿼리와 문서의 구조가 복잡해질 수 있다.             |
| 여러개의 인덱스로 나눌 때 | 각각의 경우에 최적화된 쿼리와 문서 구조를 사용할 수 있다  | 관리해야할 인덱스의 수가 많아 관리 리소스가 발생할 수 있다. |

# 샤드란?
인덱스에 색인되는 문서가 저장되는 물리적인 공간이다.

하나의 인덱스는 반드시 하나 이상의 샤드를 가진다.

샤드에는 프라이머리 샤드와 레플리카 샤드가 존재한다.

프라이머리 샤드는 문서가 저장되는 원본 샤드, 색인과 검색 성능에 모두 영향을 준다.

레플리카 샤드는 검색 성능에 영향을 주며 프라이머리 샤드에 문제가 생기면 레플리카 샤드가 프라이머리로 승격한다.

```http request
PUT /library/_settings
Content-Type: application/json

{
    "index" : {
        "number_of_shards : 5,
        "number_of_replicase" : 2
    }
}
```
이렇게 요청을 보내면 프라이머리 5개, 레플리카 10개를 생성한다.

# 샤드 라우팅
es의 기본 라우팅 룰은 모듈러 연산이다. 그래서 샤드의 개수가 바뀌면 문서가 저장되는 규칙이 완전히 바뀌게 된다.

그래서 인덱스를 생성하면 프라이머리 샤드의 개수를 변경할 수 없다.

개수를 변경하고싶다면, 기존 인덱스를 삭제하거나 재색인해야한다.
1. 새 인덱스 생성 : 원하는 프라이머리 샤드 개수로 새로운 인덱스를 만든다.
2. 데이터 재색인 : es의 reindex api를 사용해서 기존 인덱스의 데이터를 새로운 인덱스로 복사한다.




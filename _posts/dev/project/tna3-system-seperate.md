---
layout: post
title: "시스템 분리에 대한 회고"
date: 2023-12-08 08:46:00 +0900
categories:
  - dev
  - project
description: >
  '투어&티켓 전체 리뉴얼 프로젝트'
---

# 시스템 분리
![그림1](/assets/img/experience/project-review/tna3-system-seperate/img.png)

저는 21년도 6월부터 백앤드 개발을 시작하면서, 자바라는 언어를 처음 접해본지 2년 반정도 지난 주니어 개발자입니다.

회사에서 이번에 TNA3.0이란 프로젝트를 진행하고 있는데, 해당 과정에서 겪었던 시스템 분리에 대한 고민을 기록하고자합니다. 

아직 프로젝트도 진행중이며, 명쾌한 해답이 있는 주제도 아니기 때문에 더 많은 고민을 할 수 있었던 것 같습니다.  

회고가 가지는 본연의 의미는 부족한점을 기록하면서 성장하는것이기 때문에, 느끼고 배운 여러가지 점들을 까먹기전에 기록하고자합니다.

먼저 TNA3.0이란 투어&티켓 시스템을 리뉴얼하면서 루비 코드를 전부 코틀린으로 컨버팅하는 프로젝트입니다.

단순히 언어만 컨버팅하는게 아니라, 다양한 요구사항들을 반영하면서 아예 완전히 새로운 시스템을 만드는것이 목표입니다.

# 시스템 분리에 대한 여러 옵션들

기존에 없던 재고 시스템이 새롭게 생겼고 상품과 옵션의 개념도 기존의 방식과 완전히 달라졌습니다. 

결국 파트너(여행 상품을 판매하는 고객), 매니저(상품을 관리하는 직원), 여행자(상품을 구매하는 고객)별로 모두 새롭게 만들어야했습니다.

도메인으로는 크게 캘린더, 옵션, 재고, 상품으로 나누었는데, 모든 기능들을 하나의 레포에서 관리하는게 옳은가에 대한 고민이 들었습니다. 

때 마침 팀원들중 한 분이 저와 비슷한 생각을 갖고 계셨습니다.

팀 내부적으로 미팅을 통해 다양한 의견을 주고 받았고, 시스템 분리에 대한 옵션을 크게 3가지로 좁힐 수 있었습니다.

* 첫번째는 "단일 레포로 유지하며 여행자와 백오피스의 클라이언트의 진입 모듈을 분리하고 코어모듈은 공유한다. 대신 서버는 여행자, 백오피스 서버로 나눈다" 이었습니다. 
* 두번째는 "여행자와 백오피스로 레포를 아예 분리한다. 즉 서버도 분리하고 레포도 분리한다." 이었습니다. 
* 마지막은 "상품 노출(상품, 옵션, 캘린더..)와 상품 관리(재고, 예약연동, 환불..)으로 레포를 분리한다" 이었습니다.

결론부터 말씀드리면, 제가 제시한 두번째 의견인 "여행자와 백오피스로 레포를 아예 분리한다" 방향이 결론지어졌는데요. 

해당 의견이 도출된 제 생각은 아래와 같았습니다. 

먼저 최범균님의 "도메인 주도 개발 시작하기" 라는 책의 "도메인 모델과 경계라는 챕터"에서 보면 이런 문구가 있습니다.

"처음 도메인 모델을 만들 때 빠지기 쉬운 함정이 도메인을 완벽하게 표현하는 단일 모델을 만드는 시도를 하는 것이다." 

위 문구를 해당 프로젝트에 빗대어 생각해보면 아래와 같은 의심을 해볼 수 있습니다.

* 파트너, 매니저가 사용하는 상품, 옵션, 재고, 캘린더가 여행자가 사용하는 상품, 옵션, 재고, 캘린더와 같을까?
* 단일 도메인으로 너무 완벽하게 만드려는 실수를 범하고 있는게 아닐까?
* 그렇다면 바운디드 컨택스트에 따라서 아예 시스템을 나누는게 좋지 않을까?

또한 이렇게 시스템을 분리한다면 상품과 옵션 도메인에서는 여행자 서버에 쿼리 api 만 존재하게 됩니다.

요구사항을 분석했을때, 모든 커맨드 api는 백오피스에만 존재했고, 이는 상품과 옵션 도메인에서는 CQRS의 장점들도 가져갈 수 있다고 생각했습니다.

생각해본 CQRS의 장점으로는 아래와 같습니다.
* 상품과 옵션 도메인에서는 커맨드 작업이 없으므로, 사이드 이펙트로 인한 데이터 변경이 없다는 보안상 안전합니다. 
* 프로잭션으로 쿼리를 튜닝하거나, 데이터소스를 분리하는 방식으로 조회 성능 튜닝이 가능하다는점이 있습니다. 
* 비지니스가 발전함에따라 커맨드 영역의 객체지향스러운 코드를 쿼리 영역이 침범하지 못합니다.

그리고 마지막으로 백오피스가 다운되어도 여행자가 상품을 보면서 예약하는게 가능해야하므로 여행자 서버와 백오피스 서버를 분리했는데요.

이렇게 레포를 분리했을 때, 각 서버에 필요한 코드만을 가져갈 수 있게될 것으로 기대했습니다.

# 단일 레포에 모듈만 분리하는 방법
그렇다면 첫번째 옵션인 "단일 레포로 유지하며 여행자와 백오피스의 클라이언트의 진입 모듈을 분리하고 코어모듈은 공유한다"는 어떤 장점이 있을까요? 

가장 큰 장점은, 중복 코드가 가져오는 유지보수의 어려움과 개발생산성 저하를 줄일 수 있다는 점 이었는데요.

실제로 사내에서의 특정 다른 프로젝트는 같은 레포에 모듈만 분리해서 두개의 서버에 각각 배포하는식으로 운영되고 있었습니다.

덕분에 근본적으로 시스템을 분리하는 목적이 무엇인지 고민해보았는데요. 같은 레포에 모듈로만 나누는경우에 비교해서, 아예 레포를 분리하는 구성이 가지는 장단점을 생각해봤습니다.

장점 
* 바운디드 컨택스트에 따라 도메인이 분리되므로 비지니스가 섞이는 일이 없다.
* 트래픽이 늘어났을 때, 개별적인 성능 튜닝이 가능하다.
* 여행자 서버는 여행자 서버에 필요한 코드들만 갖게되고, 백오피스 서버는 백오피스에만 필요한 코드들을 가지게 된다.
* 배포시에 영향도를 줄일 수 있다.

단점
* 중복되는 코드들이 많이 양산됨으로써, 개발 생산성 저하가 올 수 있다.
* 운영시에 엔티티 칼럼을 추가하려면 두 곳에서 작업해야한다.
* 시스템 복잡도가 상승한다.

하지만 이러한 비판적인 생각 이후에도 여전히 도메인 복잡도와 확장 가능성을 생각했을때 시스템을 분리하는게 좋겠다고 판단했습니다. 

또한 공통되는 코드들은 당연히 생기겠지만, 요구사항으로 보았을때 단순 조회나 생성 빼고는 겹치는 비지니스 로직이 거의 없어보였고, 커맨드 로직과 조회 로직의 발전이 지속적으로 다른 방향으로 나아갈것으로 보였습니다.

또한 여행자 코드만 수정해도 여행자 서버와 백오피스 서버에 각각 배포해야한다는 단점이 존재했습니다. 

만약 여행자 서버에만 배포가 이뤄질 경우, 비지니스의 발전은 대부분 여행자 서버에서 이뤄질것으로 생각했고, 결국 여행자 서버 코드가 많이 앞서나가는 경우가 있을텐데요.

그러다가 나중에 백오피스 서버에도 배포가 이뤄졌을때, 장애가 발생하면 원인을 찾을 수 없는 대형 장애로 이어질 수 있기 때문에, 코드 변경시에 매번 각각 배포해주는 작업이 필요할것으로 생각했고 이는 비효율적이라고 결론 지었습니다.

해당 옵션이 비록 몇가지 단점들로 이번 프로젝트에 적용하지 않기로 결정지었지만, "너무 잘게 시스템을 분리함으로써, 시스템 복잡도를 올리는 것에 대해서는 경계하자"라는 기조를 팀 내에 공유할 수 있었습니다. 

위에서 언급한 공통된 코드들로 인한 유지보수의 어려움과, 시스템간의 네트워크 홉을 한번 더 타야한다는점이 주요했습니다.

# 상품 노출 시스템과 상품 관리 시스템으로 분리하는 방법
다음으로는 상품 노출 시스템과 상품 관리 시스템으로 분리하는것이었는데요. 

이러한 관점으로 분리했을때의 장점은 아래와 같았습니다.

상품을 노출만 하는 시스템은 정말 쿼리만 존재합니다. 예를 들어서 여행자에게 상품을 노출하거나 옵션을 노출하는 행위는 전부 상품 노출 시스템에 해당합니다. 

반대로 모든 커맨드형 서비스는 상품 관리 시스템에 존재합니다. 따라서 네티서버를 기반으로한 웹플럭스와 코루틴으로 효율적인 비동기 로직을 구현할 수 있습니다.

앞에서 말씀드린 여행자 서버와 백오피스로 나눈 경우에는 상품과 옵션은 커맨드와 쿼리가 완벽하게 분리되었지만, 여행자 서버의 재고 도메인에서 예약에 따른 재고를 차감하는 커맨드 api가 존재하기 때문에 재고까지 고려하면 완벽한 쿼리 서버라고 보기는 어려웠습니다. 

물론 재고 시스템만 따로 분리할수도 있었지만, 위에서 언급한것과 같이 "너무 잘게 시스템을 분리함으로써 시스템 복잡도를 올리는것은 지양하자" 라는게 팀 내부적으로 공유하는 규칙이었기 때문에 최대 2개로 먼저 분리하고자 했습니다.

하지만 해당 구현은 백오피스 기능과 재고 기능이 같은 상품 관리 서버에 존재하기때문에 실수로 엑셀을 과도하게 업로드해서 서버가 다운되면 재고도 같이 다운되면서 여행자들은 예약도 같이 진행할 수 없게됩니다.

이러한 이유로 결국 여행자 서버와 백오피스 서버로 시스템을 분리하는게 좋겠다는 결론이 지어졌습니다.

# 느낀점

짧은 글로 정리했지만, 위 주제로 꽤 오랜시간 논의하는 과정을 거쳤는데요.

모든 의견에는 나름대로의 타당한 이유가 있었고, 트레이드 오프를 고려해서 현재 상황에 맞는 최적의 옵션을 찾는게 중요했습니다.

여러가지 자료들을 찾아보고 공부해보고 토론하면서 느낀점은 결국 정답은 없고 트레이드 오프가 있다는 점을 인정하는 **자세**가 가장 중요하다고 느꼈습니다.

이러한 과정속에서, 제가 발전하고 있다는걸 스스로 느낄 수 있었는데요. 

개인적으로 "자유롭게 의견을 펼칠 수 있는 분위기가 나의 성장을 만들 수 있구나" 라고 생각했습니다. 

최근에 들었던 세미나중 하나가 5년차와 10년차 개발자의 차이가 무엇일까? 이었는데요. 바로 "문화를 만들어갈 수 있냐 없냐" 였습니다.

또한 최근에 읽은 최범균님의 "육각형 개발자"를 보면 입사후에는 동료들의 신뢰를 얻는게 중요하다라고 적혀있는데요.

동료들의 신뢰를 얻고, 이러한 문화를 만들어갈 수 있는 개발자로 성장해야겠다라고 다짐했습니다.

이번 기록을 통해서 스스로 더 성숙한 문화를 만들어갈 수 있는 개발자가 될 수 있기를 기원해봅니다.

# Reference
아래는 시스템 분리에 대한 결정까지 오는데 참조한 다양한 래퍼런스입니다.

블로그 : https://wonit.tistory.com/628

최범균님의 CQRS 아는척 하기 1편 : https://www.youtube.com/watch?v=xf0kXMTFJm8

최범균님의 CQRS 아는척 하기 2편 : https://www.youtube.com/watch?v=H1IF3BUeFb8&t=2s

마소 : https://learn.microsoft.com/ko-kr/azure/architecture/patterns/cqrs

우아한 형제들 : https://www.youtube.com/watch?v=BnS6343GTkY

우아한 형제들 : https://www.youtube.com/watch?v=fg5xbs59Lro&t=582s




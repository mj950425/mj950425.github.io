---
layout: post
title: "자바 스레드가 CPU에서 어떻게 실행되는가?"
date: 2024-09-17 08:46:00 +0900
categories:
  - jvm-lang
---

# 자바의 유저 모드 스레드와 커널 모드 스레드가 CPU에서 어떻게 실행되는가?

자바를 공부하다 보면 자바 스레드와 커널 스레드가 1:1 매핑된다는 이야기를 자주 듣게 됩니다.

그런데 `그래서 자바 스레드는 CPU에서 코드는 어떻게 실행되는가?` 라는 질문이 항상 남아 있었습니다. 

이번 글에서는 관련 개념을 정리해보고자 합니다.

## 커널 스레드의 커널 모드와 유저 모드

자바에서 Thread 객체는 `유저 모드 스레드`로 동작하며, 이 스레드는 커널 스레드의 참조값을 간접적으로 다루기 위한 래퍼 역할을 합니다.

자바에서 start() 메서드를 호출하면, JVM은 내부적으로 운영체제의 스레드 관리 API(일반적으로 POSIX API)를 활용하여 새로운 커널 스레드를 생성하고, 이 커널 스레드가 유저 모드 스레드의 작업을 실행하도록 요청합니다. 

즉, 자바의 유저 스레드는 커널 스레드와 1:1로 매핑되고, 커널 스레드가 실제 물리적 CPU 코어에서 실행됩니다. 

이와 달리 C 언어에서는 POSIX 스레드 API를 직접 호출하여 커널 스레드를 생성하고 실행하는 방식입니다. 

아래는 C언어와 자바의 스레드 생성 및 실행을 비교한 코드입니다.

C언어 (POSIX 스레드 API 사용):
```c
int main() {
    pthread_t thread;
    pthread_create(&thread, NULL, thread_function, NULL);
    ...
}
```

자바:
```java
public static void main(String[] args) {
    Thread thread = new Thread(new ThreadExample());
    thread.start();
    ...
}
```

여기서 중요한 점은, **커널 스레드만이 물리적인 CPU 코어에서 실행될 수 있다는 점입니다.** 

자바 애플리케이션의 코드도 결국 커널 스레드에 의해 처리됩니다.

## 커널 스레드의 커널 모드와 유저 모드

커널 스레드는 유저 모드와 커널 모드, 두 가지 실행 모드가 있습니다.

대부분의 애플리케이션 코드는 커널 스레드가 유저 모드에서 실행합니다.

이때 시스템 자원에 직접 접근할 수 없기 때문에 더 안전하게 애플리케이션을 실행할 수 있습니다.

하지만 파일 입출력이나 네트워크 처리, 시스템 콜 같은 작업이 필요하면, 커널 스레드는 커널 모드로 전환되어 이러한 작업을 처리합니다.

커널 모드에서는 시스템 자원에 직접 접근할 수 있으며, 이를 통해 안전하고 효율적인 자원 관리가 이루어집니다.

## 결론

자바에서 유저 모드 스레드는 커널 스레드와 1:1 매핑되어 실제로는 커널 스레드가 CPU에서 코드를 실행합니다. 

유저 스레드는 이러한 커널 스레드를 간단히 래핑한 객체로, 덕분에 개발자는 시스템 레벨의 세부 사항을 신경 쓰지 않고도 동시성 프로그래밍을 구현할 수 있습니다.

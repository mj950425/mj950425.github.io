---
layout: post
title: "시스템 분리에 대한 회고"
date: 2023-11-13 08:46:00 +0900
categories:
  - experience
  - project
description: >
  '투어&티켓 전체 리뉴얼 프로젝트'
---

# TNA3.0 프로젝트
![그림1](/assets/img/experience/project/tna3-system-seperate/img.png)

저는 21년도 6월부터 백앤드 개발을 시작하면서, 자바라는 언어를 처음 접해본지 2년 반정도 지난 주니어 개발자입니다.

회사에서 이번에 TNA3.0이란 프로젝트를 진행하고 있는데, 해당 과정에서 겪었던 시스템 분리에 대한 고민을 기록하고자합니다. 

아직 프로젝트도 진행중이며, 명쾌한 해답이 있는 주제도 아니었고, 팀원들과 소통할때 부족한 말주변으로 어려움도 겪었는데요. 

회고가 가지는 본연의 의미는 부족한점을 기록하면서 성장하는것이기 때문에, 느끼고 배운 여러가지 점들을 까먹기전에 기록하고자합니다.

먼저 TNA3.0이란 투어&티켓 시스템을 리뉴얼하면서 루비 코드를 전부 코틀린으로 컨버팅하는 프로젝트입니다.

단순히 언어만 컨버팅하는게 아니라, 다양한 요구사항들을 반영하면서 아예 완전히 새로운 시스템을 만드는것이 목표입니다.

2023년도 9월부터 시작했고 2024년도 4월에 입점상품들을 먼저 서비스 오픈하고, 바로 그 다음 페이즈에 연동 상품들을 오픈함으로써 대략 1년정도 이어질것으로 보이는 장기 프로젝트입니다.

# 시스템 분리에 대한 여러 옵션들

기존에 없던 재고 시스템이 새롭게 생겼고 옵션의 개념도 기존의 방식과 완전히 달라졌습니다. 결국 파트너(여행 상품을 판매하는 고객), 매니저(상품을 관리하는 직원), 여행자(상품을 구매하는 고객)별로 모두 새롭게 만들어야했습니다.

도메인으로는 크게 캘린더, 옵션, 재고, 상품으로 나누었는데, 모든 기능들을 하나의 레포에서 관리하는게 옳은가에 대한 고민이 들었습니다. 때 마침 팀원들중 한 분이 저와 비슷한 생각을 갖고 계셨습니다.

팀 내부적으로 미팅을 통해 시스템 분리에 대한 옵션을 크게 3가지로 좁힐 수 있었습니다.

첫번째는 "단일 레포로 유지하며 여행자와 백오피스의 클라이언트의 진입 모듈을 분리하고 코어모듈은 공유한다" 이었습니다. 

두번째는 "여행자와 백오피스로 레포를 아예 분리한다" 이었습니다. 

마지막은 "상품 노출(상품, 옵션, 캘린더..)와 상품 관리(재고, 예약연동, 환불..)으로 레포를 분리한다" 이었습니다.

여기에서 제 의견은 두번째 "여행자와 백오피스로 레포를 아예 분리한다" 이었는데요. 

해당 의견이 도출된 제 생각은 아래와 같았습니다. 

먼저 최범균님의 "도메인 주도 개발 시작하기" 라는 책의 "도메인 모델과 경계라는 챕터"에서 보면 이런 문구가 있습니다.

"처음 도메인 모델을 만들 때 빠지기 쉬운 함정이 도메인을 완벽하게 표현하는 단일 모델을 만드는 시도를 하는 것이다." 

위 문구를 해당 프로젝트에 빗대어 생각해보면 파트너, 매니저가 사용하는 상품, 옵션, 재고, 캘린더가 여행자가 사용하는 상품, 옵션, 재고, 캘린더와 같을까?

단일 도메인으로 너무 완벽하게 만드려는 실수를 범하고 있는게 아닐까? 그렇다면 바운디드 컨택스트에 따라서 아예 시스템을 나누는게 좋지 않을까?

또한 이렇게 시스템을 나눈다면 상품과 옵션 도메인에서는 여행자 서버에 쿼리 api 만 존재하며, 모든 커맨드 api는 백오피스에만 존재할것으로 생각되었고, 이는 상품과 옵션 도메인에서는 CQRS의 장점들도 가져갈 수 있다고 생각했습니다.

CQRS의 장점으로는 상품과 옵션 도메인에서는 커맨드 작업이 없으므로 데이터 변경이 없다는 보안상의 안전이 있고, 성능 튜닝이 가능하다는점이 있습니다. 

그리고 가장 큰 장점은 비지니스가 발전함에따라 커맨드 영역의 객체지향스러운 코드를 쿼리 영역이 침범하지 못한다는 장점도 있습니다.

그리고 마지막으로 백오피스가 다운되어도 여행자가 상품을 보면서 예약하는게 가능합니다.

이러한 근거로 제 의견을 전달했을때 나온 추가 의견이 "단일 레포로 유지하며 여행자와 백오피스의 클라이언트의 진입 모듈을 분리하고 코어모듈은 공유한다" 이었는데요. 

시스템을 분리했을 때 공통되는 코드의 개발이 가져오는 유지보수의 어려움과 개발생산성 저하가 이유였습니다. 

덕분에 근본적으로 시스템을 분리하는 목적이 무엇인지 고민해보았고, 책에서 나온 내용과 조금 비슷해보인다고 바로 시스템을 분리하려는 오류를 범하는게 아닐까? 라는 비판적인 생각을 해볼 수 있었습니다.

하지만 이러한 비판적인 생각 이후에도 여전히 각각의 도메인은 커보였고 확장의 여지가 충분하다고 생각했습니다. 

또한 공통되는 코드들은 당연히 생기겠지만, 요구사항으로 보았을때 단순 조회나 생성 빼고는 겹치는 비지니스 로직이 거의 없다고 생각했고 이는 확장할수록 더 뚜렷해질것으로 생각했습니다.

그렇지만 저 또한 너무 잘게 시스템을 분리하는것에는 거부감이 있었는데, 위에서 언급한 공통된 코드들로인한 유지보수의 어려움과 서로 통신해야하는 부분에서 네트워크 홉을 한번 더 타야한다는점이 주요했습니다.

다음으로는 상품 노출 시스템과 상품 관리 시스템으로 분리하는것이었는데요. 이를 뒷바침하는 근거는 아래와 같았습니다.

먼저 여행자 서버와 백오피스로 나눈 경우에는 여행자 서버의 재고 도메인에서 예약에 따른 재고를 차감하는 커맨드 api가 존재합니다.

따라서 상품과 옵션은 쿼리 서버이지만 재고까지 고려하면 완벽한 쿼리 서버라고 보기는 어려웠습니다. 

물론 재고 시스템만 따로 분리할수도 있었지만 너무 잘게 시스템을 분리하지말자는 팀이 공유하는 의견이었습니다.

하지만 상품을 노출만 하는 시스템은 정말 쿼리만 존재합니다. 따라서 네티서버를 기반으로한 웹플럭스와 코루틴으로 효율적인 비동기 로직을 구현할 수 있습니다. 

하지만 해당 구현은 백오피스 기능과 재고 기능이 같은 상품 관리 서버에 존재하기때문에 실수로 엑셀을 과도하게 업로드해서 서버가 다운되면 재고도 같이 다운되면서 여행자들은 예약도 같이 진행할 수 없습니다.

이러한 이유로 결국 여행자 서버와 백오피스 서버로 시스템을 분리하는게 좋겠다는 결론이 지어졌습니다.

# 느낀점

짧은 글로 정리했지만, 위 주제로 꽤 오랜시간 논의하는 과정을 거쳤는데요. 긴 과정동안 "정답은 없고 트레이드 오프가 있다는 점을 인정하는 자세"가 가장 중요하다고 느꼈습니다. 

하지만 또 너무 소극적인 자세만 고수한다면 회의의 결론이 평생 나지 않을 수 있다고 느꼈는데요. 

실제로 의견을 종합해서 듣고 결정을 내려주는 돌파형 타입의 구성원이나 리더가 팀에 필요하다고 느꼈던게, 해당 논의도 최종적으로는 팀장님의 결정으로 정리되었습니다.

아무래도 정답이 있는 문제가 아니므로 쉽사리 결정하기 어렵기 떄문이었던것 같습니다. 

최범균님의 "육각형 개발자"를 보면 입사하고 일년정도는 묵묵히 주어진일을 수행하면서 동료들의 신뢰를 쌓는게 중요하다는 말도 있는데요. 

업무 특성상 대부분의 팀 구성원들과 일해본적 없던 제 의견을 무조건 강요하기보다는, 신뢰를 빠른 시간에 쌓아가면서 시스템 분리가 다시 필요하다고 느껴지면 그 때 다시 이야기해보는것도 좋은 전략이었겠다 라고 느꼈습니다.

아래는 제가 생각한 의견을 전달드리는 과정 중 하나였는데요. 그 때 당시에는 나름 깊은 생각하고 적었다고 느꼈지만, 다시 보면 아쉬운점도 많은것 같습니다. 

최근에 들었던 세미나중 하나가 5년차와 10년차 개발자의 차이가 무엇일까? 이었는데요. 

우아콘에서도 연설하신 강사님의 말씀으로는 "바로 문화를 만들어갈 수 있냐 없냐" 였습니다. 

이번 기록을 통해서 스스로 더 성숙한 문화를 만들어갈 수 있는 개발자가 될 수 있기를 기원해봅니다.

![그림1](/assets/img/experience/project/tna3-system-seperate/img_1.png)

<br>

![그림1](/assets/img/experience/project/tna3-system-seperate/img_2.png)

<br>

![그림1](/assets/img/experience/project/tna3-system-seperate/img_3.png)

<br>

![그림1](/assets/img/experience/project/tna3-system-seperate/img_4.png)

<br>

# Reference
아래는 시스템 분리에 대한 결정까지 오는데 참조한 다양한 래퍼런스입니다.

블로그 : https://wonit.tistory.com/628

최범균님의 CQRS 아는척 하기 1편 : https://www.youtube.com/watch?v=xf0kXMTFJm8

최범균님의 CQRS 아는척 하기 2편 : https://www.youtube.com/watch?v=H1IF3BUeFb8&t=2s

ms : https://learn.microsoft.com/ko-kr/azure/architecture/patterns/cqrs

우아한 형제들 : https://www.youtube.com/watch?v=BnS6343GTkY

우아한 형제들 : https://www.youtube.com/watch?v=fg5xbs59Lro&t=582s




# 카프카의 구성 요소

## 컨수머 그룹

## 브로커
브로커는 고가용성을 위해 여러대가 될 수 있다.
브로커가 갖는 파티션을 다른 파티션에 복제한다. 이것을 리더와 레플리카라고 부른다.
실제로 컨수머 그룹이 읽는 파티션은 리더 파티션이다.
컨수머 그룹이 리더 파티션의 메세지를 읽어가면 오프셋을 올리고 비동기로 레플리카의 오프셋도 올린다.

## 컨수머 그룹
파티션의 개수보다 컨수머의 개수가 많으면 안된다.
컨수머별로 하나의 파티션을 맡기 때문에 컨수머의 개수가 더 많으면 컨수머가 아무것도 안하고 논다.

## 동작
1. 프로듀서가 카프카 클러스터로 메시지를 퍼블리싱한다.
2. 클러스터는 해당 파티션의 리더 브로커에게 메시지를 전달한다.
3. 리더 브로커는 메시지를 기록하고 이를 팔로워 브로커에게 비동기로 복제한다.
4. 리더 브로커가 장애를 발생시키면, 주키퍼가 이를 감지한다.
5. 주키퍼는 새로운 리더 브로커를 설정한다.

## Z-node
주키퍼의 Z노드는 용도에 따라 일시 노드(Ephemeral ZNode)와 순차 노드(Sequential ZNode)로 사용할 수 있습니다. 선택은 주키퍼를 사용하는 애플리케이션이나 시스템의 요구 사항에 따라 달라집니다. 카프카는 주키퍼를 사용하여 다양한 메타 데이터를 관리하며, 이 과정에서 여러 유형의 Z노드를 활용합니다. 카프카에서 주키퍼를 어떻게 사용하는지와 어떤 유형의 Z노드를 사용하는지에 대해 설명드리겠습니다.

### Z노드의 유형과 사용 사례

1. **일시 노드(Ephemeral ZNode)**:
    - **특징**: 클라이언트 세션이 유지되는 동안만 존재하며, 세션 종료 시 자동으로 삭제됩니다.
    - **사용 사례**: 분산 잠금, 클러스터 멤버십 관리 등 일시적인 상태 정보를 저장하는 데 사용됩니다.
    - **예**: 클라이언트가 종료되면 자동으로 제거되어야 하는 리소스 잠금 정보.

2. **순차 노드(Sequential ZNode)**:
    - **특징**: 노드를 생성할 때마다 고유한 순번이 부여됩니다. 다른 노드와 구분되는 순번을 통해 순차적인 처리를 가능하게 합니다.
    - **사용 사례**: 리더 선출, 이벤트 순서 관리 등 순차적인 처리가 필요한 경우 사용됩니다.
    - **예**: 리더 선출 시 가장 작은 번호를 가진 노드를 리더로 선택하는 경우.

3. **일반 노드(Persistent ZNode)**:
    - **특징**: 클라이언트가 명시적으로 삭제하지 않는 한 영구적으로 존재합니다.
    - **사용 사례**: 영구적인 구성 정보, 상태 정보 등을 저장하는 데 사용됩니다.
    - **예**: 애플리케이션 구성 정보, 서비스 디스커버리 정보 등.

### 카프카에서 주키퍼 사용 사례

카프카는 주키퍼를 사용하여 클러스터 메타 데이터를 관리합니다. 카프카에서 주키퍼를 사용하는 주요 용도와 이에 따른 Z노드 유형은 다음과 같습니다:

1. **브로커 등록**:
    - 카프카 브로커가 시작될 때 주키퍼에 자신을 등록합니다. 이를 통해 클러스터의 다른 구성 요소들이 해당 브로커의 존재를 알 수 있습니다.
    - **사용 노드**: 일시 노드(Ephemeral ZNode)
    - **경로 예**: `/brokers/ids/[broker_id]`
    - **설명**: 브로커가 종료되면 일시 노드가 자동으로 삭제되어 해당 브로커가 더 이상 활성 상태가 아님을 표시합니다.

2. **토픽 메타 데이터 저장**:
    - 각 토픽의 파티션 정보, 리더 브로커 정보 등을 저장합니다.
    - **사용 노드**: 일반 노드(Persistent ZNode)
    - **경로 예**: `/brokers/topics/[topic_name]`
    - **설명**: 토픽과 관련된 메타 데이터를 영구적으로 저장하여 클러스터 재시작 후에도 정보를 유지합니다.

3. **파티션 리더 선출**:
    - 파티션의 리더 브로커를 선출하고 관리합니다.
    - **사용 노드**: 일시 노드(Ephemeral ZNode) 또는 순차 노드(Sequential ZNode)
    - **경로 예**: `/brokers/topics/[topic_name]/partitions/[partition_id]/state`
    - **설명**: 리더 선출 정보를 저장하여 파티션의 리더 브로커를 관리합니다. 이 정보는 클라이언트가 파티션의 리더를 찾는 데 사용됩니다.

4. **컨슈머 그룹 관리**:
    - 컨슈머 그룹과 관련된 오프셋 정보, 그룹 멤버십 정보를 저장합니다.
    - **사용 노드**: 일반 노드(Persistent ZNode)
    - **경로 예**: `/consumers/[group_id]/offsets/[topic]/[partition]`
    - **설명**: 컨슈머 그룹의 오프셋 정보를 영구적으로 저장하여, 컨슈머가 재시작된 후에도 메시지 처리 위치를 유지합니다.

### 요약

- **Z노드 유형 선택**: 주키퍼의 Z노드를 일시 노드로 사용할지 순차 노드로 사용할지는 사용자(애플리케이션)의 요구 사항에 따라 결정됩니다.
- **카프카의 주키퍼 사용**: 카프카는 주키퍼를 사용하여 브로커 등록, 토픽 메타 데이터 저장, 파티션 리더 선출, 컨슈머 그룹 관리 등의 작업을 수행합니다.
    - **일시 노드**: 브로커 등록, 리더 선출 등.
    - **순차 노드**: 리더 선출 등 순차적인 이벤트 처리가 필요한 경우.
    - **일반 노드**: 토픽 메타 데이터, 컨슈머 오프셋 정보 등 영구적인 데이터 저장.

### 추가 질문들

**Q1:** 주키퍼의 일시 노드(Ephemeral ZNode)가 클라이언트 세션 종료 시 자동으로 삭제되는 메커니즘에 대해 설명해 주세요.

**Q2:** 카프카 클러스터에서 브로커가 주키퍼와의 연결을 잃었을 때 발생할 수 있는 상황과 그에 대한 대응 방법은 무엇인가요?

**Q3:** 주키퍼를 사용하여 카프카의 컨슈머 그룹 오프셋을 관리하는 방법과 그 장점에 대해 설명해 주세요.